{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Duck Shop</h1>
    <div id="items" class="row">
        </div>
</div>

<style>
    .item {
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 8px;
        background-color: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .name { font-size: 18px; font-weight: bold; }
    .desc {
        margin: 6px 0;
        flex-grow: 1;
    }
    .price { font-size: 16px; color: #333; }
    .item button {
        margin-top: auto;
    }
</style>

<script>
    // --- (createItemElement function is unchanged) ---
    function createItemElement(item) {
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 mb-4";
        col.innerHTML = `
            <div class="item">
                <div class="name">${item.name}</div>
                <div class="desc">${item.description}</div>
                <div class="price">Price: ${item.price} ducks</div>
                <button onclick="purchase(${item.id}, '${item.name}')" class="btn btn-primary w-100">Buy</button>
            </div>
        `;
        return col;
    }

    async function loadItems() {
        const res = await fetch("/shop/items");
        const data = await res.json(); // Data has keys: 'automated', 'custom_info', 'physical'

        const container = document.getElementById("items");
        container.innerHTML = "";

        // --- FIX 1: Changed keys to lowercase ---
        const groupTitles = {
            automated: "ðŸ’Ž Instant Perks",
            custom_info: "ðŸŽ¨ Custom Orders",
            physical: "ðŸ“¦ Physical Goods & Rentals"
        };

        // --- FIX 2: Changed keys to lowercase ---
        const groupOrder = ['automated', 'custom_info', 'physical'];

        for (const key of groupOrder) {
            // This will now correctly find data['automated'], etc.
            const items = data[key];

            if (items && items.length > 0) {
                const titleEl = document.createElement('h2');
                titleEl.className = 'col-12 mt-3 mb-3';
                titleEl.textContent = groupTitles[key] || key;
                container.appendChild(titleEl);

                items.forEach(item => {
                    const itemEl = createItemElement(item);
                    container.appendChild(itemEl);
                });
            }
        }
    }

    // --- (purchase function is unchanged) ---
    async function purchase(id, name) {
        const message = `Are you sure you want to buy ${name}?`;
        if (!window.confirm(message)) {
            return;
        }

        const res = await fetch(`/shop/purchase/${id}`, {
            method: "POST"
        });

        const out = await res.json();

        if (!res.ok) {
            alert(out.error || "An unknown error occurred.");
            return;
        }

        alert(`Success! Purchased ${out.item} for ${out.price_paid} ducks.`);

        if (out.fulfillment_type === 'custom_info') {
            alert("You will now be redirected to provide custom details for your order.");
            window.location.href = `/shop/provide-info/${id}`;

        } else if (out.fulfillment_type === 'automated') {
            location.reload();

        } else if (out.fulfillment_type === 'physical') {
            alert("Your order has been placed. Please see an admin to pick up your item.");
            loadItems();
        } else {
            location.reload();
        }
    }

    loadItems();
</script>

{% endblock %}