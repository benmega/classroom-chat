{% extends 'base.html' %}

{% block content %}
{% set is_owner = (session.get('user') == target.id) or (viewer and viewer.is_admin) %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_profile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sprite.css') }}">

{% if is_owner %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile_picture_modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/cropper.min.css') }}">
    <style>
        .edit-project-overlay {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.7); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease;
            text-decoration: none; z-index: 10;
        }
        .project-thumb:hover .edit-project-overlay { opacity: 1; }
        .edit-project-overlay:hover { background: #007bff; color: white; }
    </style>
{% endif %}

<div class="profile-container">

    <div class="profile-header-card">
        <div class="header-background"></div>
        <div class="header-content">
            <div class="avatar-wrapper" style="position: relative;">
                {% set pfp = target.profile_picture if target.profile_picture else 'Default_pfp.jpg' %}
                <img src="{{ url_for('user.profile_picture', filename=pfp) }}"
                     alt="{{ target.username }}"
                     class="avatar-img"
                     id="current-profile-img">

                {% if is_owner %}
                    <button type="button" class="edit-pic-btn" id="edit-pic-trigger" title="Change Profile Picture">
                        <i class="fas fa-camera"></i>
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display:none;">
                {% endif %}
            </div>

            <div class="student-identity">
                <h1 class="student-name">{{ target.nickname or target.username }}</h1>
                <p class="student-title">{{ target.username }} | Aspiring Coder</p>
                {% if is_owner %}
                    <div style="margin-top: 10px;">
                        <a href="{{ url_for('user.edit_profile') }}" class="btn-launch" style="padding: 5px 15px; font-size: 0.9rem;">
                            <i class="fas fa-user-cog"></i> Account Settings
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="duck-stats">
                <div class="stat-box">
                    <span class="label">Lifetime Ducks</span>
                    <span class="value">{{ target.earned_ducks }}</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-box highlight">
                    <span class="label">Duck Balance</span>
                    <span class="value"><i class="fas fa-coins"></i> {{ target.duck_balance }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="grid-card">
            <div class="icon-circle blue"><i class="fas fa-tasks"></i></div>
            <div class="card-text"><h3>{{ target.challenge_logs | length }}</h3> <p>Challenges Solved</p></div>
        </div>
        <div class="grid-card">
            <div class="icon-circle green"><i class="fas fa-project-diagram"></i></div>
            <div class="card-text"><h3>{{ target.projects | length }}</h3><p>Projects Built</p></div>
        </div>
        <div class="grid-card">
            <div class="icon-circle gold"><i class="fas fa-trophy"></i></div>
            <div class="card-text"><h3>{{ target.certificates | default([]) | length }}</h3><p>Certificates</p></div>
        </div>
        <div class="grid-card">
            <div class="icon-circle purple"><i class="fas fa-star"></i></div>
            <div class="card-text"><h3>{{ target.skills | length }}</h3><p>Skills Unlocked</p></div>
        </div>
    </div>

    <div class="dashboard-panel">
         <div class="panel-header"><h2><i class="fas fa-calendar-alt"></i> Daily Coding Effort</h2></div>
         <div class="graph-scroll-container">
            {% set graph_data = target.get_contribution_data() %}
            <table class="contribution-table">
                <thead>
                    <tr>
                        <td style="width: 30px"></td>
                        {% for month in graph_data.months %}
                            <td class="month-label" colspan="{{ month.colspan }}">{{ month.name }}</td>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% set day_labels = ["", "Mon", "", "Wed", "", "Fri", ""] %}
                    {% for row_index in range(7) %}
                    <tr class="graph-row">
                        <td class="day-label">
                            <span class="sr-only">{{ day_labels[row_index] }}</span>
                            <span aria-hidden="true">{{ day_labels[row_index] }}</span>
                        </td>
                        {% for week_data in graph_data.rows[row_index] %}
                            {% if week_data %}
                                <td class="day-cell" data-level="{{ week_data.level }}" title="{{ week_data.count }} contributions on {{ week_data.date }}"></td>
                            {% else %}
                                <td class="day-cell" data-level="0"></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="column-left">
            <div class="dashboard-panel">
                <div class="panel-header"><h2><i class="fas fa-chart-line"></i> Curriculum Progress</h2></div>
                {% set cc_levels = target.get_progress("codecombat.com") %}
                {% set cc_percent = target.get_progress_percent("codecombat.com") %}
                <div class="progress-item">
                    <div class="prog-label"><span>CodeCombat</span><span>{{ cc_percent }}%</span></div>
                    <div class="progress-track"><div class="progress-fill" style="width: {{ cc_percent }}%;"></div></div>
                    <small>{{ cc_levels }} Levels Completed</small>
                </div>
                {% set oz_levels = target.get_progress("www.ozaria.com") %}
                {% set oz_percent = target.get_progress_percent("www.ozaria.com") %}
                <div class="progress-item">
                    <div class="prog-label"><span>Ozaria</span><span>{{ oz_percent }}%</span></div>
                    <div class="progress-track"><div class="progress-fill ozaria-fill" style="width: {{ oz_percent }}%;"></div></div>
                    <small>{{ oz_levels }} Levels Completed</small>
                </div>
            </div>

            <div class="dashboard-panel">
                <div class="panel-header"><h2><i class="fas fa-tools"></i> Technical Stack</h2></div>
                <h4 class="skill-category-title">Languages & Tools</h4>
                <div class="skill-grid-visual">
                    {% for skill in target.skills if skill.category in ['language', 'tool'] %}
                    <div class="skill-card-visual level-{{ skill.proficiency }}">
                        <i class="{{ skill.icon }} fa-2x"></i>
                        <span>{{ skill.name }}</span>
                        <div class="star-rating">{% for i in range(skill.proficiency) %}<i class="fas fa-star"></i>{% endfor %}</div>
                    </div>
                    {% else %}
                        <p style="color:#888; font-size: 0.9rem; grid-column: 1/-1;">No languages recorded.</p>
                    {% endfor %}
                </div>
                <hr style="border-top: 1px dashed #eee; margin: 15px 0;">
                <h4 class="skill-category-title">Core Concepts</h4>
                <div class="skill-list-concepts">
                    {% for skill in target.skills if skill.category == 'concept' %}
                    <div class="concept-tag"><i class="fas fa-check-circle"></i> {{ skill.name }}</div>
                    {% else %}
                        {% for skill in target.skills if not skill.category %}
                            <span class="skill-tag">{{ skill.name }}</span>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="column-right">
            {% if target.certificates %}
            <div class="dashboard-panel">
                <div class="panel-header"><h2><i class="fas fa-certificate"></i> Verified Certificates</h2></div>
                <div class="cert-list">
                    {% for cert in target.certificates %}
                    <div class="cert-item">
                        <div class="cert-icon">
                            {% set achievement_slug = cert.achievement.slug if cert.achievement else 'default' %}
                            <div class="badge-container"><div class="badge badge-{{ achievement_slug }}">&nbsp;</div></div>
                        </div>
                        <div class="cert-info">
                            <h4>{{ cert.achievement.name if cert.achievement else "Course Completion" }}</h4>
                            <span class="cert-date">Awarded: {{ cert.submitted_at.strftime('%b %Y') if cert.submitted_at else 'Recently' }}</span>
                        </div>
                        {% if cert.file_path %}
                            <a href="{{ url_for('achievements.view_certificate', cert_id=cert.id) }}" target="_blank" class="cert-link">View File</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="dashboard-panel">
                <div class="panel-header" style="justify-content: space-between; align-items: center;">
                    <h2><i class="fas fa-gamepad"></i> Project Portfolio</h2>
                    {% if is_owner %}
                        <a href="{{ url_for('user.new_project') }}" class="btn-launch" style="font-size: 0.8rem;">
                            <i class="fas fa-plus"></i> New Project
                        </a>
                    {% endif %}
                </div>

                <div class="project-grid">
                    {% for project in target.projects %}
                        <div class="project-card">
                            <div class="project-thumb js-open-project-modal"
                                 data-target="modal-{{ project.id }}">

                                {% if project.image_url %}
                                    <img src="{{ url_for('static', filename=project.image_url) }}" alt="{{ project.name }}">
                                {% else %}
                                    <div class="code-pattern-bg"><i class="fas fa-layer-group"></i></div>
                                {% endif %}

                                {% if is_owner %}
                                    <a href="{{ url_for('user.edit_project', project_id=project.id) }}"
                                       class="edit-project-overlay"
                                       title="Edit Project"
                                       onclick="event.stopPropagation();">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                {% endif %}
                            </div>

                            <div class="project-content">
                                <h3>{{ project.name }}</h3>
                                <p class="project-excerpt">{{ project.description | truncate(80) }}</p>

                                <div class="project-actions">
                                    {% if project.link %}
                                        <a href="{{ project.link }}" target="_blank" class="btn-launch">
                                            <i class="fas fa-external-link-alt"></i> Demo
                                        </a>
                                    {% endif %}
                                    <button class="btn-details js-open-project-modal" data-target="modal-{{ project.id }}">
                                        <i class="fas fa-file-code"></i> Case Study
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="modal-{{ project.id }}" class="project-modal-overlay" style="display:none;">
    <div class="project-modal-content">

        <button class="modal-close js-close-project-modal">&times;</button>

        <div class="modal-header">
            <h2>{{ project.name }}</h2>
        </div>

        <div class="modal-action-bar">
            {% if project.link %}
                <a href="{{ project.link }}" target="_blank" class="btn-action btn-play">
                    <i class="fas fa-rocket" style="margin-right: 8px;"></i> Try Live Project
                </a>
            {% endif %}

            {% if project.video_url %}
                <button class="btn-action btn-watch js-open-video-lightbox"
                        data-video-url="{{ project.video_url }}">
                    <i class="fas fa-play-circle" style="margin-right: 8px;"></i> Watch Video Walkthrough
                </button>
            {% endif %}
        </div>

        <div class="modal-body-grid">
            <div class="modal-left">



                <div class="info-block">
                    <h4>About this Project</h4>
                    <p>{{ project.description }}</p>
                </div>

                {% if project.teacher_comment %}
                <div class="info-block teacher-feedback" style="background-color: #f8f9fa; border-left: 4px solid #2ecc71; padding: 15px;">
                    <h4 style="color: #27ae60; margin-top: 0;"><i class="fas fa-comment-dots"></i> Instructor Feedback</h4>
                    <blockquote style="margin: 0; font-style: italic; color: #555;">"{{ project.teacher_comment }}"</blockquote>
                </div>
                {% endif %}
            </div>

            <div class="modal-right">
                <h4>Code Logic</h4>
                {% if project.code_snippet %}
                    <div class="code-scroll-container">
                        <pre><code>{{ project.code_snippet }}</code></pre>
                    </div>
                {% elif project.github_link %}
                    <div class="github-box">
                        <i class="fab fa-github fa-3x"></i>
                        <p>Code hosted on GitHub</p>
                        <a href="{{ project.github_link }}" target="_blank" class="btn-github">View Repo</a>
                    </div>
                {% else %}
                    <p class="no-code">No code preview available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="video-lightbox" class="video-modal-overlay">
    <div class="video-modal-content" onclick="event.stopPropagation()">
        <button class="video-close-btn js-close-video-lightbox">&times;</button>
        <div class="video-wrapper">
            <iframe id="lightbox-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
</div>

{% if is_owner %}
<div id="crop-modal" class="modal">
    <div class="modal-content">
        <button class="close-btn" id="close-modal">&times;</button>
        <h3>Adjust your profile picture</h3>
        <div style="max-height: 400px; overflow: hidden;">
            <img id="preview" alt="Preview" style="max-width: 100%;">
        </div>
        <div class="modal-buttons">
            <button id="crop-btn" class="btn-launch">Crop & Save</button>
        </div>
    </div>
</div>
{% endif %}

{% if is_owner %}
    <script src="{{ url_for('static', filename='lib/cropper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/users/profile.js') }}"></script>
{% else %}
    <script src="{{ url_for('static', filename='js/users/profile.js') }}"></script>
{% endif %}

{% endblock %}