<!--
File: submit_challenge.html
Type: html
Summary: Challenge submission template for codecombat.com/Ozaria links.
-->

{% extends "base.html" %} {% block content %}
<h2>Submit a Challenge</h2>
<form method="POST" action="{{ url_for('challenge.submit_challenge') }}">
  <div class="form-group">
    <label for="url">Challenge URL *</label>
    <input
      type="url"
      name="url"
      id="url"
      class="form-control"
      placeholder="https://codecombat.com/play/level/..."
      required
    />
  </div>

  <div class="form-group mt-3">
    <label for="helpers">Who helped you? (optional)</label>
    <input
      type="text"
      name="helpers"
      id="helpers"
      class="form-control"
      placeholder="blossomstudentXX"
    />
  </div>

  <div class="form-group mt-3">
    <label for="notes">Notes (optional)</label>
    <textarea
      name="notes"
      id="notes"
      rows="3"
      class="form-control"
      placeholder="What did you learn or struggle with?"
    ></textarea>
  </div>

  <button type="submit" class="btn btn-primary mt-3">Submit</button>
</form>
<a
  href="javascript:(function(){const p=new URLSearchParams();p.append('url',window.location.href);p.append('helpers','');p.append('notes','');fetch('https://benmega.com/challenge/submit',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p,credentials:'include'}).then(r=>r.text()).then(t=>alert(t)).catch(e=>alert('Error submitting challenge: '+e));})();"
  title="Drag this to your bookmarks bar"
  onclick="
    alert('To install, please drag this link to your bookmarks bar.');
    return false;
  "
  style="
    padding: 10px 15px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
    display: inline-block;
  "
>
  ‚û°Ô∏è Submit Challenge ü¶Ü
</a>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/submit_challenge.css') }}"
/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% if message %}
<script>
  // --- Quack Logic ---
  function playQuackSound() {
      return new Promise((resolve, reject) => {
          // Use Flask url_for to ensure the path is correct
          const quack = new Audio("{{ url_for('static', filename='sounds/quack.mp3') }}");
          quack.onended = resolve;
          quack.onerror = reject;
          // Handle autoplay policies by catching errors
          quack.play().catch((err) => {
              console.warn("Autoplay prevented:", err);
              resolve(); // Resolve anyway to continue the loop
          });
      });
  }

  async function playQuacksSequentially(count) {
      for (let i = 0; i < count; i++) {
          await playQuackSound();
      }
  }

  // --- Alert & Trigger Logic ---
  {% if message %}
      {% if success %}
          Swal.fire({
              title: 'Congratulations!',
              text: '{{ message|escape }}',
              icon: 'success',
              confirmButtonText: 'Awesome!',
              // Trigger quacks immediately when the alert opens
              didOpen: () => {
                  {% if quack_count and quack_count > 0 %}
                      playQuacksSequentially({{ quack_count }});
                  {% endif %}
              }
          });
      {% else %}
          Swal.fire({
              title: 'Info',
              text: '{{ message|escape }}',
              icon: 'info',
              confirmButtonText: 'Continue'
          });
      {% endif %}
  {% endif %}
</script>
{% endif %} {% endblock %}
